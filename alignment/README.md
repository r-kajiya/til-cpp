# アライメントの重要性

アライメントとは４バイト(32bit機の場合)区切りごとにintやshortなどのデータを置くこと

メリットは４バイト区切りでデータを置くことで区切りをまたぐことなくデータにアクセスできるので同じデータに２回アクセスしなくてもよい可能性が高まる

デメリットはshortやcharでも４バイトメモリを食うこと

アライメントやパディングをしっかり考えてデータ構造を作成することでメモリ節約できてもアクセス速度も効率が良くなる

CPUがメモリアクセスを行うとき、区切りごとにとってくるとは限らず、ある程度の塊をもってメモリにあるデータを取得する

その大きさは環境によってさまざまである。

vsでは#pragma packを使用してアンアラインド・データ・アクセスをおこなうことができる

これを使用すると区切りをまたいでデータを詰めれるのでメモリに優しいが、またいでるデータに関しては２回アクセスするなどがあるのでアクセス速度は低下する


# 計測結果

64bit環境,Releaseビルド,

ループカウント : 1000000000

NonPack = #pragma packを使用していない構造体

メモリ:24byte

速度:(1)980ms (2)981ms (3)985ms (4)982ms (5)971ms

Pack = #pragma packを使用している構造体

メモリ:15byte

速度:(1)973ms (2)979ms (3)966ms (4)980ms (5)964ms

予想は#pragma packを使用しないアライメントされた構造体アクセス速度が速いと思っていたが、

予想に反して、doubleに2回アクセスする可能性が高いアンアラインド・データ・アクセス構造体がはやかった。

なぜだろう、キャッシュミスが少なくなるのか何か別の要因があるのか

個人的にはこれならば、パックしたほうが良いのではないかと感じた

# 参考URL

<https://www.aps-web.jp/academy/cm/08/>

<http://www7b.biglobe.ne.jp/~robe/cpphtml/html03/cpp03014.html>
